// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Organization {
  id            String   @id @default(uuid())
  ownerPlayerId String
  createdAt     DateTime @default(now())
  lastActiveAt  DateTime @default(now())
  lastSimulatedAt DateTime @default(now())
  walletData    String   // JSON ResourceBundle
  
  progressTracks ProgressTrack[]
  agents         AgentInstance[]
  tasks          TaskInstance[]
  facilities     FacilityInstance[]
  taskOffers     TaskOffer[]
  
  @@index([ownerPlayerId])
}

model ProgressTrack {
  id            String   @id @default(uuid())
  organizationId String
  trackKey      String
  currentValue  Float    @default(0)
  
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, trackKey])
  @@index([organizationId])
}

model AgentTemplate {
  id            String   @id @default(uuid())
  baseStatsData String   // JSON NumericStatMap
  growthProfileData String // JSON Map<number, NumericStatMap>
  tagsData      String   // JSON string[]
  
  instances     AgentInstance[]
}

model AgentInstance {
  id            String   @id @default(uuid())
  organizationId String
  templateId    String
  level         Int      @default(1)
  experience    Int      @default(0)
  effectiveStatsData String // JSON NumericStatMap
  status        String
  currentTaskId String?
  
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template      AgentTemplate @relation(fields: [templateId], references: [id])
  
  @@index([organizationId])
  @@index([status])
}

model TaskArchetype {
  id            String   @id @default(uuid())
  category      String
  baseDurationMs Int
  minAgents     Int
  maxAgents     Int
  primaryStatKey String
  secondaryStatKeysData String // JSON string[]
  entryCostData String   // JSON ResourceBundle
  baseRewardData String  // JSON ResourceBundle
  requiredTrackThresholdsData String // JSON Map<string, number>
  
  instances     TaskInstance[]
  offers        TaskOffer[]
}

model TaskOffer {
  id            String   @id @default(uuid())
  organizationId String
  taskArchetypeId String
  createdAt     DateTime @default(now())
  expiresAt     DateTime?
  isTaken       Boolean  @default(false)
  assignedTaskInstanceId String?
  
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  archetype     TaskArchetype @relation(fields: [taskArchetypeId], references: [id])
  
  @@index([organizationId])
  @@index([isTaken, expiresAt])
}

model TaskInstance {
  id                  String   @id @default(uuid())
  organizationId      String
  taskArchetypeId     String
  originOfferId       String?
  assignedAgentIdsData String // JSON AgentId[]
  startedAt           DateTime
  expectedCompletionAt DateTime
  completedAt         DateTime?
  status              String
  outcomeCategory     String?
  outcomeDetailsData  String?  // JSON
  
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  archetype           TaskArchetype @relation(fields: [taskArchetypeId], references: [id])
  
  @@index([organizationId])
  @@index([status, expectedCompletionAt])
}

model FacilityTemplate {
  id            String   @id @default(uuid())
  typeKey       String
  tierConfigsData String // JSON Map<number, TierConfig>
  
  instances     FacilityInstance[]
}

model FacilityInstance {
  id            String   @id @default(uuid())
  organizationId String
  facilityTemplateId String
  currentTier   Int
  constructedAt DateTime @default(now())
  lastUpgradeAt DateTime @default(now())
  
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template      FacilityTemplate @relation(fields: [facilityTemplateId], references: [id])
  
  @@index([organizationId])
}

model UnlockRule {
  id            String   @id @default(uuid())
  trackKey      String
  thresholdValue Float
  effectsData   String   // JSON UnlockEffects
}
