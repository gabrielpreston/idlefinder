---
globs: "src/**/*.ts,src/**/*.tsx,svelte.config.js,package.json,tsconfig.json,prisma/**/*.prisma"
description: SvelteKit idle game architecture patterns, domain-driven design, TypeScript organization, and Prisma persistence
---

# Idle Game Architecture Standards

## SvelteKit Application Architecture

### Core Application Structure

**Main Components:**
- `src/routes/` - SvelteKit routes and pages
- `src/lib/domain/` - Pure domain logic (no framework dependencies)
  - `entities/` - Domain entities (Adventurer, Mission, Facility, etc.)
  - `valueObjects/` - Value objects (Identifier, Timestamp, Duration, ResourceBundle, etc.)
  - `systems/` - Simulation systems (MissionDurationModifiers, CraftingSystem, etc.)
- `src/lib/app/` - Application services (use-case orchestration)
- `src/lib/repos/` - Repository interfaces and Prisma implementations
- `src/lib/stores/` - Svelte stores for client state management
- `prisma/schema.prisma` - Database schema definitions

### Domain-Driven Design Structure

```
src/lib/domain/
├── entities/
│   ├── Adventurer.ts
│   ├── Mission.ts
│   ├── Facility.ts
│   └── GameState.ts
├── valueObjects/
│   ├── Identifier.ts
│   ├── Timestamp.ts
│   ├── Duration.ts
│   ├── ResourceUnit.ts
│   ├── ResourceBundle.ts
│   └── NumericStatMap.ts
└── systems/
    ├── MissionDurationModifiers.ts
    ├── CraftingSystem.ts
    └── SlotGenerationSystem.ts
```

### Domain Entity Pattern

```typescript
// src/lib/domain/entities/Adventurer.ts
export class Adventurer {
  constructor(
    public readonly id: AdventurerId,
    public readonly name: string,
    public readonly attributes: AdventurerAttributes,
    public state: AdventurerState
  ) {}

  // Domain logic methods
  canStartMission(): boolean {
    return this.state.status === 'idle';
  }
}
```

### Domain System Pattern

### Domain System Pattern

```typescript
// src/lib/domain/systems/MissionDurationModifiers.ts
export function calculateEffectiveDuration(
  mission: Mission,
  adventurer: Adventurer | undefined,
  state: GameState
): Duration {
  const baseDuration = mission.attributes.baseDuration;
  const modifiers: DurationModifier[] = [];
  // Collect modifiers from adventurer abilities, facility bonuses, etc.
  return calculateEffectiveDurationBase(baseDuration, modifiers);
}
```

### TypeScript Organization Patterns

#### Module Structure

```
src/
├── routes/
│   ├── +page.svelte
│   └── api/
├── lib/
│   ├── domain/
│   │   ├── entities/
│   │   ├── valueObjects/
│   │   └── systems/
│   ├── app/
│   ├── repos/
│   └── stores/
└── app.html
```

#### Import Organization

```typescript
// 1. External dependencies
import { json } from '@sveltejs/kit';
import type { RequestHandler } from './$types';

// 2. Domain entities and value objects
import { AdventurerId, MissionId } from '$lib/domain/valueObjects/Identifier';
import { Mission } from '$lib/domain/entities/Mission';
import { Timestamp } from '$lib/domain/valueObjects/Timestamp';

// 3. Domain systems
import { calculateEffectiveDuration } from '$lib/domain/systems/MissionDurationModifiers';
```

### Error Handling Patterns

#### Domain Validation

```typescript
// src/lib/domain/entities/Adventurer.ts
export class Adventurer {
  canStartMission(): boolean {
    if (this.state.status !== 'idle') {
      throw new DomainError('Adventurer is not available');
    }
    return true;
  }
}
```

#### Application Service Error Handling

```typescript
// src/lib/app/StartTaskService.ts
export class StartTaskService {
  async execute(...): Promise<StartTaskResult> {
    try {
      // Validation and business logic
      if (!this.validateInput(...)) {
        return { success: false, error: 'Invalid input' };
      }

      // Domain operations
      const result = await this.performOperation(...);
      return { success: true, ...result };
    } catch (error) {
      if (error instanceof DomainError) {
        return { success: false, error: error.message };
      }
      throw error; // Re-throw unexpected errors
    }
  }
}
```

### Deterministic Simulation Pattern

```typescript
// All domain systems are pure functions
export function calculateEffectiveDuration(
  mission: Mission,
  adventurer: Adventurer | undefined,
  state: GameState
): Duration {
  // Given the same inputs, always produces the same outputs
  // No side effects, no external dependencies
  // Uses deterministic random if needed (seeded)
}
```

## Quality Gates

### Architecture Validation

- **Separation of concerns**: Domain logic is pure TypeScript, no framework dependencies
- **Domain-driven design**: Entities, value objects, and systems follow DDD principles
- **Repository pattern**: Data access abstracted behind interfaces
- **Deterministic simulation**: Systems produce consistent results given same inputs
- **Type safety**: Complete TypeScript type coverage with strict mode
- **Persistence abstraction**: Prisma implementation hidden behind repository interfaces
- **Error handling**: Domain errors vs application errors properly handled
